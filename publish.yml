run-test-pages:
  stage: build
  image: python:latest
  script:
    - cd docs
    - pip install mkdocs-material
    - pip install mkdocs-git-revision-date-plugin
    - mkdocs build --site-dir ../test
  allow_failure: true
  artifacts:
    paths:
    - test
  when: manual

pages:
  stage: publish
  image: python:latest
  needs:
    - job: generate-allure-report
      artifacts: true
      optional: true
  script: |
    # Generate dynamic Markdown for Allure links inside existing docs/
    echo "## Test Reports" > docs/docs/allure_reports.md

    if [ -d "tmp/allure" ]; then
      for dir in tmp/allure/*; do
        if [ -d "$dir" ]; then
          module=$(basename "$dir")
          echo "Found Allure report for module: $module"
          echo "- [$module]($CI_PAGES_URL/allure/$module/index.html)" >> docs/docs/allure_reports.md
        fi
      done
    else
      echo "No Allure reports found â€” skipping Allure links."
    fi

    # Build MkDocs site
    cd docs
    pip install --default-timeout=1000 mkdocs-material mkdocs-git-revision-date-plugin
    mkdocs build --site-dir ../public
    cd ..

    # Copy Allure reports into public/allure AFTER MkDocs build
    mkdir -p public/allure
    if [ -d "tmp/allure" ]; then
      for dir in tmp/allure/*; do
        if [ -d "$dir" ]; then
          module=$(basename "$dir")
          echo "Publishing Allure report for module: $module"
          mkdir -p "public/allure/$module"
          cp -r "$dir/." "public/allure/$module/"
        fi
      done
    fi

    # Ensure GitLab Pages serves all folders, including _assets etc.
    touch public/.nojekyll
  artifacts:
    paths:
      - public
