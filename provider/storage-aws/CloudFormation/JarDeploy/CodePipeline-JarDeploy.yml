# Copyright Â© Amazon Web Services
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

AWSTemplateFormatVersion: 2010-09-09

Description: >
  This CloudFormation script creates the deployment pipeline for OSDU's storage service. The CodePipeline
  should automatically trigger whenever commits are made on the tracked branch. The start and end
  of the CodePipeline should trigger a SNS alert to keep track of when the deployment has started
  and when it finishes.

Parameters:
  Environment:
    Description: Environment Name. Defaults to 'dev'. Can only be dev/uat/prod.
    Type: String
    AllowedValues:
      - dev
      - uat
      - prod
    Default: dev

  DeploymentRegion:
    Description: The AWS region to deploy the application to. The default is us-east-1.
    Type: String
    Default: us-east-1

  SNSNotificationEmail:
    Description: The email address to send SNS notifications about the build to.
    Type: String
    Default: barclay.walsh@parivedasolutions.com

  CodeCommitRepositoryName:
    Description: The name of the Code Commit Repository that the CodePipeline source is connected to.
    Type: String
    Default: os-storage

  JarServiceBase:
    Description: The name of the service base path for the JAR files (e.g. 'storage').
    Type: String
    Default: storage

  CodeCommitBranchName:
    Description: The name of the Code Commit branch that the CodePipeline source is connected to.
    Type: String
    Default: dev

Resources:
  ArtifactStoreBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      VersioningConfiguration:
        Status: Enabled

  ArtifactStoreBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ArtifactStoreBucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:*
            Effect: Allow
            Resource:
              - !Sub arn:aws:s3:::${ArtifactStoreBucket}
              - !Sub arn:aws:s3:::${ArtifactStoreBucket}/*
            Principal:
              AWS:
                - !Sub arn:aws:iam::${AWS::AccountId}:root
                - !ImportValue
                  'Fn::Sub': '${Environment}-CodeBuildRoleArn'
                - !ImportValue
                  'Fn::Sub': '${Environment}-PipelineRoleArn'
                - !ImportValue
                  'Fn::Sub': '${Environment}-CFNRoleArn'

  CachingBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      VersioningConfiguration:
        Status: Enabled

  CachingBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CachingBucket
      PolicyDocument:
        Statement:
          - Action:
              - s3:*
            Effect: Allow
            Resource:
              - !Sub arn:aws:s3:::${CachingBucket}
              - !Sub arn:aws:s3:::${CachingBucket}/*
            Principal:
              AWS:
                - !Sub arn:aws:iam::${AWS::AccountId}:root
                - !ImportValue
                  'Fn::Sub': '${Environment}-CodeBuildRoleArn'
                - !ImportValue
                  'Fn::Sub': '${Environment}-PipelineRoleArn'
                - !ImportValue
                  'Fn::Sub': '${Environment}-CFNRoleArn'

  SNSCodePipelineDeploymentFailed:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref SNSNotificationEmail
          Protocol: email
      TopicName: !Sub '${Environment}-OS-Storage-Deployment-CodePipeline-JarDeploy-Failed'

  EventRuleCodePipelineFailed:
    Type: AWS::Events::Rule
    Properties:
      Description: Triggered whenever the CodePipeline deployment stage has failed.
      EventPattern:
        source:
          - "aws.codepipeline"
        detail-type:
          - "CodePipeline Stage Execution State Change"
        detail:
          state:
            - "FAILED"
          pipeline:
            - !Sub '${Environment}-OSDU-OS-Storage-CodePipeline-JarDeploy'

      Name: !Sub ${Environment}-CodePipelineEventRule-${CodeCommitRepositoryName}-JarDeploy
      Targets:
      -
        Arn:
          !Ref SNSCodePipelineDeploymentFailed
        Id: "Deployment-CodePipeline-JarDeploy-Failed"
        InputTransformer:
          InputPathsMap:
            pipeline : "$.detail.pipeline"
          InputTemplate: '"The Pipeline <pipeline> has failed."'

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      ArtifactStore:
        Location: !Ref ArtifactStoreBucket
        Type: S3
      Name: !Sub '${Environment}-OSDU-OS-Storage-CodePipeline-JarDeploy'
      RoleArn: !ImportValue
        'Fn::Sub': '${Environment}-PipelineRoleArn'
      Stages:
        - Name: Source
          Actions:
            - Name: Source
              ActionTypeId:
                Category: Source
                Owner: AWS
                Provider: CodeCommit
                Version: '1'
              Configuration:
                BranchName: !Ref CodeCommitBranchName
                RepositoryName: !Ref CodeCommitRepositoryName
              OutputArtifacts:
                - Name: Source
              RunOrder: '1'

        - Name: CodeBuild
          Actions:
            - Name: Jar-CodeBuild
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: '1'
              InputArtifacts:
                - Name: Source
              OutputArtifacts:
                - Name: Jar-CodeBuild
              Configuration:
                ProjectName: !Ref JarCodeBuild
              RunOrder: '2'

  JarCodeBuild:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${Environment}-jar-codebuild-${CodeCommitRepositoryName}
      Description: >
        CodeBuild commands which handle setting environment variables, along with the
        build, test, and packaging of the .jar file. It then uses the AWS CLI to copy
        the versioned JAR and associated build files to the shared jar-deploy S3 bucket.
      ServiceRole: !ImportValue
        'Fn::Sub': '${Environment}-CodeBuildRoleArn'
      Artifacts:
        Type: S3
        Location: !Ref ArtifactStoreBucket
        Name: !Sub ${Environment}-jar-codebuild
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:2.0
        EnvironmentVariables:
          - Name: ENVIRONMENT
            Type: PLAINTEXT
            Value: !Ref Environment
          - Name: AWS_ACCOUNT_ID
            Type: PLAINTEXT
            Value: !Ref AWS::AccountId
          - Name: AWS_REGION
            Type: PLAINTEXT
            Value: !Ref DeploymentRegion
          - Name: APPLICATION_NAME
            Type: PLAINTEXT
            Value: !Ref CodeCommitRepositoryName
          - Name: JAR_SERVICE_BASE
            Type: PLAINTEXT
            Value: !Ref JarServiceBase
          - Name: M2_REPO_S3_BUCKET
            Type: PLAINTEXT
            Value: !Sub "${Environment}-${AWS::AccountId}-persistent-maven-m2-bucket"
          - Name: JAR_DEPLOY_S3_BUCKET
            Type: PLAINTEXT
            Value: !Sub ${Environment}-${AWS::AccountId}-osdu-jar-deploy
        PrivilegedMode: true
      Source:
        BuildSpec: ./provider/storage-aws/buildspec-jar-deploy.yml
        Location: !Sub https://git-codecommit.${AWS::Region}.amazonaws.com/v1/repos/${CodeCommitRepositoryName}
        Type: CODECOMMIT
      Cache:
        Type: S3
        Location: !Sub ${CachingBucket}/${Environment}
      TimeoutInMinutes: 15
      VpcConfig:
        SecurityGroupIds:
          - Fn::ImportValue:
              !Sub "${Environment}-OSDU-CodeBuildSecurityGroup"
        Subnets:
          - Fn::ImportValue:
              !Sub "${Environment}-OSDU-PrivateSubnet-AZ1"
          - Fn::ImportValue:
              !Sub "${Environment}-OSDU-PrivateSubnet-AZ2"
        VpcId:
          Fn::ImportValue:
            !Sub "${Environment}-OSDU-VPC"
